---
title: æ ‘çŠ¶æ•°ç»„
date: 2024-04-27 23:09:57
updated: '2024-05-14T18:37:38.281+08:00'
tags:
top: 71000
---

æ ‘çŠ¶æ•°ç»„è®²è§£

<!-- more -->

## ç®€ä»‹

### å®šä¹‰

æ ‘çŠ¶æ•°ç»„æ˜¯ä¸€ç§ä»£ç é‡å°‘ã€å¸¸æ•°å°çš„ä¼˜ç§€æ•°æ®ç»“æ„ï¼Œå¯ä»¥åœ¨ $O(\log n)$ çš„æ—¶é—´å†…è¿›è¡Œæ•°ç»„ **æ»¡è¶³ç»“åˆå¾‹è¿ç®—** çš„å•ç‚¹ä¿®æ”¹å’ŒåŒºé—´æŸ¥è¯¢ï¼Œé€šè¿‡ä¸€å®šçš„æ”¹å˜ä¹Ÿå¯ä»¥è¿›è¡ŒåŒºé—´ä¿®æ”¹å•ç‚¹æŸ¥è¯¢ç­‰å¤æ‚æ“ä½œã€‚

æ ‘çŠ¶æ•°ç»„åœ¨ä½¿ç”¨æ—¶å˜å½¢è¾ƒå°‘ï¼Œä¸»è¦çš„å˜å½¢æœ‰ æ ‘çŠ¶æ•°ç»„ä¸ŠäºŒåˆ†ã€‚

## åŸºç¡€æ ‘çŠ¶æ•°ç»„

ä»¥æ ‘çŠ¶æ•°ç»„å¤„ç†åŒºé—´å’Œä¸ºä¾‹è®²è§£

æˆ‘ä»¬çŸ¥é“ï¼ŒåŒºé—´å’Œå¯ä»¥é€šè¿‡ä¸¤ä¸ªå‰ç¼€å’Œç›¸å‡è·å¾—ï¼Œå› æ­¤ä»¥ä¸‹åªè®¨è®ºå‰ç¼€å’Œã€‚

$$
\sum_{i = l}^{r} a_{i} = \sum_{i = 1}^{r} a_{i} - \sum_{i - 1}^{l - 1}a_{i}
$$

### å¼•å…¥


è€ƒè™‘è¿™æ ·çš„ä¸€ä¸ªé—®é¢˜ï¼š

{%note success%}
ç»™å®šä¸€ä¸ªæ•°ç»„ $a$ï¼Œæœ‰ $Q$ æ¬¡ä»¥ä¸‹ä¸¤ç§æ“ä½œï¼š
  
1. ç»™å®š $k$ï¼Œè¾“å‡º $a_{1} \sim a_{k}$ çš„å’Œã€‚
2. ç»™å®š $k$ å’Œ $x$ï¼Œå°† $a_{k}$ å˜ä¸º $a_{k} + x$
{%endnote%}

é’ˆå¯¹ä¸Šé¢çš„è¿™ä¸ªé—®é¢˜ï¼Œæœ‰ä¸¤ç§åŸºç¡€æš´åŠ›åšæ³•ï¼Œå¤æ‚åº¦å‡ä¸º $O(Qn)$ï¼Œä¼šè¶…å‡ºæ—¶é—´é™åˆ¶ã€‚

{% tabs å¼•å…¥é¢˜ç›®è§£æ³• %}
<!-- tab è§£æ³• 1 -->
æˆ‘ä»¬åªç»´æŠ¤åŸæ•°ç»„ï¼Œæ¯æ¬¡æŸ¥è¯¢æ—¶ä» $1$ åˆ° $k$ åŠ ä¸€éè·å¾—ç­”æ¡ˆã€‚

è¿™ç§è§£æ³•æ›´æ”¹çš„æ—¶é—´å¤æ‚åº¦ä¸º $O(1)$ æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¸º $O(n)$ï¼Œåœ¨æŸ¥è¯¢æ“ä½œè¾ƒå°‘æ—¶æœ‰æ˜æ˜¾ä¼˜åŠ¿ã€‚
<!-- endtab -->
<!-- tab è§£æ³• 2 -->
æˆ‘ä»¬ç»´æŠ¤ä¸€ä¸ªå‰ç¼€å’Œæ•°ç»„ $b$ï¼Œæ¯æ¬¡æ›´æ–°æ—¶éœ€è¦æ›´æ–° $b_{k \sim n}$ çš„æ‰€æœ‰å‰ç¼€å’Œï¼ŒæŸ¥è¯¢æ—¶åªéœ€è¦è¾“å‡º $b_{k}$ã€‚
è¿™ç§è§£æ³•æ›´æ”¹çš„æ—¶é—´å¤æ‚åº¦ä¸º $O(n)$ æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¸º $O(1)$ï¼Œåœ¨ä¿®æ”¹æ“ä½œè¾ƒå°‘æ—¶æœ‰æ˜æ˜¾ä¼˜åŠ¿ã€‚

åœ¨åŒä¸€ä¸ªç¨‹åºå†™å‡ºä¸¤ç§è§£æ³•ï¼Œå®é™…è°ƒç”¨æ—¶æ ¹æ®æ•°æ®ç‰¹å¾é€‰æ‹©è§£æ³•çš„å¤„ç†æ–¹å¼ç§°ä¸º **æ•°æ®åˆ†æ²»**ï¼Œè¿™å¹¶éæˆ‘ä»¬ä»Šå¤©è®¨è®ºçš„é‡ç‚¹ï¼Œè¯¦æƒ…å¯ä»¥æœŸå¾…ä»¥åçš„æ–‡ç« ã€‚
<!-- endtab -->
{% endtabs %}


### æŸ¥è¯¢

è€ƒè™‘ä¸€ä¸‹åˆšåˆšä¸¤ç§ç®—æ³•çš„ç¼ºç‚¹ï¼šéœ€è¦æ›´æ–°æˆ–æŸ¥è¯¢çš„å…ƒç´ è¿‡å¤šã€‚

æœ‰æ²¡æœ‰ä¸€ç§æ–¹æ³•èƒ½å°†å‰ç¼€å’Œåˆ†ä¸ºè‹¥å¹²ä¸ªå°åŒºé—´çš„å’Œï¼ˆåŒæ—¶åŒºé—´æ•°ä¸èƒ½å¤ªå¤šï¼Œå¦åˆ™æ›´æ–°æ—¶å¤æ‚åº¦é«˜ï¼‰ï¼Œå¹¶ä¸”æ˜“äºç»´æŠ¤å‘¢ï¼Ÿ

{%note æ‹“å±•%}
å®é™…ä¸Šï¼Œæœ‰ä¸€ç§ä¼˜åŒ–ç®—æ³•ï¼š**åˆ†å—**ï¼Œä¸“é—¨ç”¨æ¥è§£å†³åˆšåˆšæ‰€æåˆ°çš„ç¼ºç‚¹ã€‚
è¯¥ç®—æ³•å°†æ•°ç»„åˆ†ä¸º $\sqrt{n}$ å—ï¼Œæ¯å—æœ€å¤š $\sqrt{n}$ ä¸ªå…ƒç´ ï¼Œä½¿å¾—å•æ¬¡æ›´æ–°ã€æŸ¥è¯¢çš„å¤æ‚åº¦å‡ä¸º $O(\sqrt{n})$ã€‚
åˆ†å—ç®—æ³•èƒ½è§£å†³çš„é—®é¢˜æ›´å¤šï¼Œä½†æ—¶é—´å¤æ‚åº¦é«˜äºæ ‘çŠ¶æ•°ç»„ã€‚
æ­¤å¤„ä¸è¿‡å¤šä»‹ç»è¯¥ç®—æ³•ï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒåˆ†å—ä¸“é¢˜çš„æ–‡ç« ã€‚
{%endnote%}

åœ¨è®¡ç®—å’Œæ›´æ–°å‰ç¼€å’Œæ—¶ï¼Œå¦‚æœèƒ½ä¿è¯å•æ¬¡æŸ¥è¯¢/ä¿®æ”¹çš„å…ƒç´ æ•°é‡**å‡ä¸è¶…è¿‡ $\log n$ ä¸ª**ï¼Œåˆ™èƒ½å¾—åˆ°å¤æ‚åº¦ä¸º $O(n \log n)$ çš„ç®—æ³•ã€‚

è€ƒè™‘åˆ°ä¸€ä¸ªæ•°å­—è¡¨ç¤ºä¸ºäºŒè¿›åˆ¶çš„ä½æ•°ä¸è¶…è¿‡ $\log k$ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§äºŒè¿›åˆ¶ä½æ‹†åˆ†æ•°å­—ï¼š

ä¾‹å¦‚å¯¹äºæ•°å­— $166$ï¼Œè½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ—¶ä¸º $(10100110)\_{2}$ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥å°†å…¶åˆ†ä¸º $(10)\_{2}+(100)\_{2}+(100000)\_{2}+(10000000)\_{2}$ï¼Œä¹Ÿå°±æ˜¯é•¿åº¦åˆ†åˆ«ä¸º $2$ã€$4$ã€$32$ã€$128$ çš„å­åŒºé—´ã€‚

å¯ä»¥çœ‹å‡ºï¼Œæ‹†åˆ†æ•°å­—æ—¶ï¼Œæ¯æ¬¡å–æ•°å­—æœ€ä½ä½çš„ $1$ åŠå…¶åé¢çš„ $0$ ç»„æˆçš„äºŒè¿›åˆ¶æ•°ä½œä¸ºé•¿åº¦ã€‚æˆ‘ä»¬å°†â€œå–æ•°å­—æœ€ä½ä½çš„ $1$ åŠå…¶åé¢çš„ $0$â€è¿™ä¸ªæ“ä½œå®šä¹‰ä¸ºå‡½æ•° `lowbit`ï¼Œä¾‹å¦‚ $\mathrm{lowbit}(72)=\mathrm{lowbit}((1001000)\_{2})=(1000)_{2}=8$ ã€‚

è¿™ä¸ªå‡½æ•°ç”¨ä»£ç å®ç°çš„æ–¹å¼å¦‚ä¸‹ï¼š

```cpp
int lowbit(int x)
{
    return (-x)&x;
}
```

å…¶ä¸­æ¶‰åŠè®¡ç®—æœºå­˜å‚¨è´Ÿæ•°çš„æ–¹å¼â€”â€”è¡¥ç ï¼Œåœ¨æ­¤ä¸å¯¹åŸç†è¿›è¡Œè§£é‡Šï¼Œç›´æ¥èƒŒè¯µå³å¯ã€‚

---

æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ•°ç»„ $tree$ æ¥è®°å½•é¢„å¤„ç†å‡ºæ¯ä¸ªå­åŒºé—´çš„å€¼ã€‚

åœ¨æ ‘çŠ¶æ•°ç»„ä¸­ï¼Œè§„å®š $tree[i]$ ä»£è¡¨**ä»¥ $i$ ä¸ºåŒºé—´ç»ˆç‚¹ï¼Œé•¿åº¦ä¸º $\mathrm{lowbit}(i)$ çš„å­åŒºé—´**ï¼ˆå³å­åŒºé—´ $[i-\mathrm{lowbit}(i)+1,i]$ï¼‰ã€‚

å›é¡¾æˆ‘ä»¬ä¹‹å‰å¯¹æ•°å­— $166$ çš„æ‹†åˆ†æ–¹å¼ï¼Œå‘ç°æ°å¥½æ¯æ¬¡æ‹†åˆ†çš„é•¿åº¦å‡ä¸º $\mathrm{lowbit}(x)$ï¼Œäºæ˜¯æˆ‘ä»¬åªéœ€è¦è®©æ‹†åˆ†å‡ºæ¯ä¸ªå­åŒºé—´çš„ç»ˆç‚¹æ°å¥½ä¸º $x$ å³å¯ç¬¦åˆ $tree[x]$ çš„å®šä¹‰ï¼Œè¿™æ˜¯å¾ˆå®¹æ˜“åšåˆ°çš„ï¼šä»¥åˆå§‹æ•°å­—ä¸ºå³ç«¯ç‚¹ï¼Œåªéœ€è¦æ¯æ¬¡å–èµ° $\mathrm{lowbit}(x)$ çš„åŒºé—´ï¼Œå‰©ä¸‹çš„æ•°å­—å˜ä¸º $x-\mathrm{lowbit}(x)$ï¼Œä¸æ–­é‡å¤è¿™ä¸ªè¿‡ç¨‹ç›´åˆ° $x=0$ å³å¯ã€‚

æŸ¥è¯¢éƒ¨åˆ†ä»£ç ï¼š

```cpp
int query(int x)
{
    int sum = 0;
    // æœ€å¤šå‡ log(x) æ¬¡ï¼Œå¤æ‚åº¦ä¸º log(x)
    for(;x;x -= lowbit(x))
    {
        sum += tree[x];
    }
    return sum;
}
```

### ä¿®æ”¹

æŸ¥è¯¢çš„éƒ¨åˆ†å·²ç»è§£å†³äº†ï¼Œé‚£ä¹ˆä¿®æ”¹æ“ä½œåº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

æƒ³æƒ³æ•°ç»„ $tree$ çš„å®šä¹‰ï¼Œå‘ç°ä¿®æ”¹**åŸæ•°ç»„**ä½ç½® $i$ï¼Œå½±å“çš„æ˜¯ $tree$ æ•°ç»„ä¸­é‚£äº› $k-\mathrm{lowbit}(k)+1 \leq i \leq k$ çš„ä½ç½®ï¼Œè¿™æ ·çš„ä½ç½®æœ‰å¤šå°‘ä¸ªå‘¢ï¼Ÿ

æˆ‘ä»¬åˆ†æä¸€ä¸‹äºŒè¿›åˆ¶æ•°å­—çš„ç‰¹å¾ï¼ˆä»¥ä¸‹æ•°å­—å‡ä¸ºäºŒè¿›åˆ¶ï¼‰ï¼š

{%note info%}

éšä¾¿å–ä¸€ä¸ªæ•°å­— $i$ï¼Œæšä¸¾å‡ ä¸ª $k$ çœ‹çœ‹æ»¡è¶³è¦æ±‚çš„æ•°å­—æœ‰ä»€ä¹ˆç‰¹å¾ã€‚

é¦–å…ˆ $k-\mathrm{lowbit}(k)+1 \leq i$ ç­‰ä»·äº $k-\mathrm{lowbit}(k) \leq i - 1$ï¼Œä¸” $k$ è¦å¤§äºç­‰äº $i$ã€‚

```txt
i:   101000
i-1: 100111                 100111
k:   110100 --> k-lowbit(k) 110000 > i-1 
k:   101001 --> k-lowbit(k) 101000 > i-1 // å¦‚æœå‰é¢ç›¸åŒï¼Œä½†åé¢æœ‰ 1ï¼Œä¼šæ›´å¤§
k:   101000 --> k-lowbit(k) 100000 < i-1 
k:   110000 --> k-lowbit(k) 100000 < i-1
k:   111000 --> k-lowbit(k) 110000 > i-1 
```

**æ€§è´¨1ï¼š$k$ çš„åé¢ $0$ çš„ä¸ªæ•°åªèƒ½å¤§äºç­‰äº $i$ åé¢ $0$ çš„ä¸ªæ•°ã€‚å³ $\mathrm{lowbit}(k) \geq \mathrm{lowbit}(i)$**
**æ€§è´¨2: $k$ å‰é¢ï¼ˆé™¤å» $0$ çš„éƒ¨åˆ†ï¼‰ä¸èƒ½å°äº $i$ çš„ç›¸åŒåŒºåŸŸï¼Œå¦‚æœ $i$ è¿™éƒ¨åˆ†çš„æœ€åä¸€ä½æ˜¯ $0$ï¼Œåˆ™ $k$ è¿™éƒ¨åˆ†æœ€åä¸€ä½ä¸º $1$ï¼ˆå¦åˆ™è¿™ä¸ªä½ç½®å°±ä¸æ˜¯â€œå‰é¢â€äº†ï¼‰ï¼Œä¸”åªèƒ½å°†è¿™éƒ¨åˆ†çš„æœ€åä¸€ä½ä» $0$ å˜ä¸º $1$ï¼Œå…¶ä»–ä½ç½®ä¸èƒ½æ”¹å˜ã€‚ï¼ˆæœ€åä¸€ä¸ªä¾‹å­è¯´æ˜å¦‚æœå‰é¢æ”¹äº†ï¼Œä¼š $>i-1$ï¼‰**ã€‚

{%endnote%}

å¯ä»¥å‘ç°ï¼Œè¿™æ ·çš„æ•°å­—ä¸€å®šä¸è¶…è¿‡ $\log(k)$ ä¸ªï¼Œä¿®æ”¹çš„æ—¶é—´å¤æ‚åº¦å¾—ä»¥ä¿è¯ã€‚

å¦‚ä½•è·å¾—æ‰€æœ‰æ»¡è¶³è¦æ±‚çš„ $k$ å‘¢ï¼Ÿå‘ç°åªéœ€è¦ä» $i$ å¼€å§‹ï¼Œä¸æ–­å°† $i$ åŠ ä¸Š $\mathrm{lowbit}(i)$ å³å¯ã€‚

äºæ˜¯ä¿®æ”¹éƒ¨åˆ†çš„ä»£ç å¦‚ä¸‹ï¼š

```cpp
void update(int x,int val)
{
    for(;x<=n;x+=lowbit(x))
    {
        tree[x] += val;
    }
}
```

### è®²è§£æ€»ç»“

è¿™éƒ¨åˆ†å†…å®¹çš„åŸç†å¯èƒ½å¹¶ä¸æ˜¯å¾ˆå¥½ç†è§£ï¼Œä¸è¿‡ç”±äºä»£ç ç®€å•ï¼Œå¯ä»¥å…ˆåªè®°å¿†ä»£ç éƒ¨åˆ†ï¼Œéšç€å­¦ä¹ çš„æ·±å…¥ç†è§£çš„ä¼šè¶Šæ¥è¶Šå¥½ã€‚

### æ ‘çŠ¶æ•°ç»„çš„åŒºé—´ä¿®æ”¹ å•ç‚¹æŸ¥è¯¢

æ ‘çŠ¶æ•°ç»„å¯ä»¥ç»“åˆå·®åˆ†ç®—æ³•å®ç°åŒºé—´ä¿®æ”¹ï¼Œå…·ä½“çš„ï¼Œæˆ‘ä»¬ç”¨æ ‘çŠ¶æ•°ç»„ç»´æŠ¤åŸæ•°ç»„çš„å·®åˆ†æ•°ç»„ $b$ï¼š

$$
b_{i} = \begin{cases}
a_{i} & i=1 \\\\
a_{i} - a_{i - 1} & \mathrm{other}
\end{cases}
$$

æ ¹æ®å·®åˆ†å’Œå‰ç¼€å’Œçš„ç›¸å…³çŸ¥è¯†ï¼Œå°†åŒºé—´ä¿®æ”¹ã€å•ç‚¹æŸ¥è¯¢è½¬åŒ–ä¸ºäº†å•ç‚¹ä¿®æ”¹ã€å‰ç¼€æŸ¥è¯¢é—®é¢˜ã€‚

tips: å¦‚æœä½ æ— æ³•ç†è§£è¿™é‡Œï¼Œä½ éœ€è¦æŸ¥çœ‹ å·®åˆ†å’Œå‰ç¼€å’Œ çš„ç›¸å…³çŸ¥è¯†ğŸ·

### ä¾‹é¢˜


{%note primary [P46 ã€æ¨¡æ¿ã€‘æ ‘çŠ¶æ•°ç»„](https://oj.cnryh.cn/problem#/P46) %}

{% lg /images/logo.png %}
P46 ã€æ¨¡æ¿ã€‘æ ‘çŠ¶æ•°ç»„ | https://oj.cnryh.cn/problem#/P46 | 11 Online Judge
{% endlg %}

å¾ˆæ¨¡æ¿çš„é¢˜ç›®ï¼Œéœ€è¦æ³¨æ„å¸¸æ•°ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

{%note success Code%}

```cpp
#include <bits/stdc++.h>
using namespace std;
#define int long long
#define max_n 1001000
void read(int &p)
{
    p = 0;
    int k = 1;
    char c = getchar();
    while (c < '0' || c > '9')
    {
        if (c == '-')
        {
            k = -1;
        }
        c = getchar();
    }
    while (c >= '0' && c <= '9')
    {
        p = p * 10 + c - '0';
        c = getchar();
    }
    p *= k;
    return;
}
void write_(int x)
{
    if (x < 0)
    {
        putchar('-');
        x = -x;
    }
    if (x > 9)
    {
        write_(x / 10);
    }
    putchar(x % 10 + '0');
}
void writesp(int x)
{
    write_(x);
    putchar(' ');
}
void writeln(int x)
{
    write_(x);
    putchar('\n');
}
int nums[max_n], tree[max_n];
int n, Q;
int lowbit(int x)
{
    return (-x) & x;
}
void update(int x, int val)
{
    for (; x <= n; x += lowbit(x))
    {
        tree[x] += val;
    }
}
int query(int x)
{
    int res = 0;
    for (; x > 0; x -= lowbit(x))
    {
        res += tree[x];
    }
    return res;
}
signed main()
{
    read(n), read(Q);
    for (int i = 1; i <= n; i++)
    {
        update(i, i);
    }
    for (int i = 1, op, a, b; i <= Q; i++)
    {
        read(op), read(a), read(b);
        if (op == 1)
        {
            writeln(query(b) - query(a - 1));
        }
        else
        {
            update(a, b);
        }
    }
    return 0;
}
```
{%endnote%}

{%endnote%}



{%note primary [P47 å° O æŸ¥æ•°å­—](https://oj.cnryh.cn/problem#/P47) %}

{% lg /images/logo.png %}
P47 å° O æŸ¥æ•°å­— | https://oj.cnryh.cn/problem#/P47 | 11 Online Judge
{% endlg %}

{%note success å…ˆåšé¢˜ç›®å†çœ‹é¢˜è§£%}
{% tabs P47 é¢˜è§£ %}
<!-- tab é¢˜è§£ -->

<!-- endtab -->
<!-- tab ä»£ç  -->
```cpp
#include <bits/stdc++.h>
using namespace std;
#define int long long
#define max_n 1001000
void read(int &p)
{
    p = 0;
    int k = 1;
    char c = getchar();
    while (c < '0' || c > '9')
    {
        if (c == '-')
        {
            k = -1;
        }
        c = getchar();
    }
    while (c >= '0' && c <= '9')
    {
        p = p * 10 + c - '0';
        c = getchar();
    }
    p *= k;
    return;
}
void write_(int x)
{
    if (x < 0)
    {
        putchar('-');
        x = -x;
    }
    if (x > 9)
    {
        write_(x / 10);
    }
    putchar(x % 10 + '0');
}
void writesp(int x)
{
    write_(x);
    putchar(' ');
}
void writeln(int x)
{
    write_(x);
    putchar('\n');
}
int nums[max_n], tree[max_n];
int n, Q;
int lowbit(int x)
{
    return (-x) & x;
}
void update(int x, int val)
{
    for (; x <= n; x += lowbit(x))
    {
        tree[x] += val;
    }
}
int query(int x)
{
    int res = 0;
    for (; x > 0; x -= lowbit(x))
    {
        res += tree[x];
    }
    return res;
}
signed main()
{
    read(n), read(Q);
    for (int i = 1, op, a, b; i <= Q; i++)
    {
        read(op);
        if (op == 2)
        {
            read(a);
            writeln(query(a) % 2);
        }
        else
        {
            read(a), read(b);
            update(a, 1);
            update(b + 1, -1);
        }
    }
    return 0;
}
```
<!-- endtab -->
{% endtabs %}
{%endnote%}
{%endnote%}

ç”±äºæ™®é€šçš„æ ‘çŠ¶æ•°ç»„å•ç‹¬ä½¿ç”¨è¾ƒå°‘ï¼Œä¸€èˆ¬ç”¨äºå›¾è®ºæˆ–å…¶ä»–é¢˜ç›®å½“ä¸­ä½œä¸ºè¾…åŠ©å·¥å…·ï¼Œè¿™é‡Œåªä¸¾ä¸¤é“ä¾‹é¢˜ï¼Œåœ¨å­¦ä¹ å›¾è®ºåï¼Œä¼šæœ‰æ›´å¤šä¾‹é¢˜ã€‚

æ ‘çŠ¶æ•°ç»„é™¤äº†å¯ä»¥è¿›è¡Œå•ç‚¹ä¿®æ”¹åŒºé—´æŸ¥è¯¢å¤–ï¼Œè¿˜å¯ä»¥è¿›è¡ŒåŒºé—´ä¿®æ”¹å•ç‚¹æŸ¥è¯¢ï¼Œè¿™é‡Œä½¿ç”¨äº†å·®åˆ†çš„æ€æƒ³ï¼Œé€šè¿‡æ ‘çŠ¶æ•°ç»„ç»´æŠ¤å·®åˆ†æ•°ç»„æ¥å®ç°ã€‚


### æ ‘çŠ¶æ•°ç»„è¿›é˜¶ï¼šåŒºé—´ä¿®æ”¹ã€åŒºé—´æŸ¥è¯¢

#### è®²è§£æ¨å¯¼

**æ³¨æ„ï¼šæ­¤å¤„å»ºè®®ç†è§£è€Œéå•çº¯èƒŒè¯µï¼Œæ›´æœ‰åˆ©äºåé¢çŸ¥è¯†å­¦ä¹ ã€‚**

{%note%}
ç»™å®šæ•°ç»„ $a$ï¼Œç»´æŠ¤ä»¥ä¸‹æ“ä½œï¼š
- `1 L R x`ï¼šå°† $\forall i \in [l,r],a_{i}$ å˜ä¸º $a_{i}+x$ï¼›
- `2 L R`ï¼š æŸ¥è¯¢ $\sum\limits_{i = l}^{r} a_{i}$ çš„å€¼ï¼›
{%endnote%}

é¦–å…ˆï¼Œä¸ºäº†æ»¡è¶³ä¿®æ”¹æ—¶çš„æ—¶é—´å¤æ‚åº¦ï¼Œæ ‘çŠ¶æ•°ç»„ç»´æŠ¤çš„ä¸€å®šè¿˜æ˜¯åŸæ•°ç»„çš„å·®åˆ†æ•°ç»„ $b$ã€‚

é‚£ä¹ˆæŸ¥è¯¢çš„æ—¶å€™åº”è¯¥å¦‚ä½•åšå‘¢ï¼Ÿæˆ‘ä»¬å°è¯•æ¨å¯¼ä¸€ä¸‹ç­”æ¡ˆä¸ $b$ æ•°ç»„ä¹‹é—´çš„å…³ç³»ï¼ŒåŒºé—´å’Œå¯ä»¥è½¬åŒ–ä¸ºå‰ç¼€å’Œä¹‹å·®ï¼Œå› æ­¤ä¸‹é¢åªè®¨è®ºå‰ç¼€å’Œï¼š

$$
\begin{aligned}
\sum_{i = 1}^{R} &= \sum_{i = 1}^{R} \sum_{j = 1}^{i} b_{j} \\\\
&= \sum_{i = 1}^{R} b_{i} \times (R - i + 1) \\\\
&= \sum_{i = 1}^{R} [b_{i} \times (R + 1)] - \sum_{i = 1}^{R} b_{i} \times i \\\\
&= (R + 1) \sum_{i = 1}^{R} b_{i} - \sum_{i = 1}^{R} b_{i} \times i
\end{aligned}
$$

ä¸Šé¢çš„æ¨å¯¼è¿‡ç¨‹å¯ä»¥è‡ªå·±æ¨ä¸€æ¨ï¼ˆå¦‚æœæœ‰é—®é¢˜å¯ä»¥åœ¨ä¸‹æ–¹è¯„è®ºæˆ–åœ¨ [11 Online Judge](https://oj.cnryh.cn/user#/1)ç§ä¿¡æˆ‘ï¼‰ï¼Œå¯¹äºå…¶ä»–é¢˜ç›®çš„è§£å†³è¿˜æ˜¯æœ‰ä¸€å®šå¯å‘æ€§çš„ã€‚

è§‚å¯Ÿå‘ç°æˆ‘ä»¬éœ€è¦ç»´æŠ¤ $\sum_{i = 1}^{R} b_{i}$ å’Œ $\sum_{i = 1}^{R} b_{i} \times i$ï¼Œæ±‚å’Œå¯ä»¥ç”¨æ ‘çŠ¶æ•°ç»„æŸ¥è¯¢ï¼Œæ•…è€ƒè™‘ä¿®æ”¹æ—¶ $b_{i}$ å’Œ $b_{i} \times i$ ä¼šæœ‰ä»€ä¹ˆå˜åŒ–ï¼š

- å¯¹äº $b_{i}$ï¼Œæ›´æ”¹æ—¶ $b_{l} \gets b_{l} + x$ï¼Œ$b_{r+1} \gets b_{r + 1} - x$;
- å¯¹äº $b_{i} \times i$ï¼Œæ›´æ–°æ—¶ $b_{l} \times l \gets (b_{l} + x) \times l$ï¼Œ$b_{r+1} \times (r+1) \gets (b_{r + 1} - x) \times r + 1$ã€‚

äºæ˜¯å¼€ä¸¤é¢—çº¿æ®µæ ‘åˆ†åˆ«ç»´æŠ¤å³å¯ã€‚

#### æ¨¡æ¿é¢˜


{%note primary [SY52 ã€æ¨¡æ¿ã€‘åŒºé—´æ”¹æŸ¥æ ‘çŠ¶æ•°ç»„](https://oj.cnryh.cn/problem#/SY52) %}

{% lg /images/logo.png %}
SY52 ã€æ¨¡æ¿ã€‘åŒºé—´æ”¹æŸ¥æ ‘çŠ¶æ•°ç»„ | https://oj.cnryh.cn/problem#/SY52 | 11 Online Judge
{% endlg %}

ä¾æ—§æ˜¯æ¨¡æ¿é¢˜ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

{%note success Code%}
```cpp
#include <bits/stdc++.h>
using namespace std;
#define int long long
#define max_n 1010101
void read(int &p)
{
    p = 0;
    int k = 1;
    char c = getchar();
    while (c < '0' || c > '9')
    {
        if (c == '-')
        {
            k = -1;
        }
        c = getchar();
    }
    while (c >= '0' && c <= '9')
    {
        p = p * 10 + c - '0';
        c = getchar();
    }
    p *= k;
    return;
}
void write_(int x)
{
    if (x < 0)
    {
        putchar('-');
        x = -x;
    }
    if (x > 9)
    {
        write_(x / 10);
    }
    putchar(x % 10 + '0');
}
void writesp(int x)
{
    write_(x);
    putchar(' ');
}
void writeln(int x)
{
    write_(x);
    putchar('\n');
}
int n, q;
int nums[max_n];
int lowbit(int x)
{
    return (-x) & x;
}
struct BirTree
{
    int tree[max_n];
    void add(int x, int val)
    {
        for (; x <= n; x += lowbit(x))
        {
            tree[x] += val;
        }
        return;
    }
    int query(int x)
    {
        int sum = 0;
        for (; x; x -= lowbit(x))
        {
            sum += tree[x];
        }
        return sum;
    }
    int query(int l, int r)
    {
        return query(r) - query(l - 1);
    }
} tree1, tree2;
signed main()
{
    read(n), read(q);
    for (int i = 1; i <= n; i++)
    {
        read(nums[i]);
        tree1.add(i, nums[i] - nums[i - 1]);
        tree2.add(i, i * (nums[i] - nums[i - 1]));
    }
    for (int i = 1, op, l, r, x; i <= q; i++)
    {
        read(op), read(l), read(r);
        if (op == 1)
        {
            read(x);
            tree1.add(l, x);
            tree2.add(l, x * l);
            tree1.add(r + 1, -x);
            tree2.add(r + 1, -x * (r + 1));
        }
        else
        {
            writeln((r+1)*tree1.query(r)-l*tree1.query(l-1)+tree2.query(l-1)-tree2.query(r));
        }
    }
    return 0;
}
```
{%endnote%}


{%endnote%}

## äºŒç»´æ ‘çŠ¶æ•°ç»„

å‰ç½®çŸ¥è¯†ï¼šäºŒç»´å‰ç¼€å’Œã€äºŒç»´å·®åˆ†ã€æ™®é€šæ ‘çŠ¶æ•°ç»„ã€‚

äºŒä½æ ‘çŠ¶æ•°ç»„ä¸ä¸€ç»´æ ‘çŠ¶æ•°ç»„ç±»ä¼¼ï¼Œå…¶æ—¶é—´å¤æ‚åº¦ä¸º $O(Q \log^{2}(n))$ï¼Œç©ºé—´å¤æ‚åº¦ä¸º $O(n^{2})$ï¼Œé€‚åˆç»´æŠ¤è§„æ¨¡ä¸å¤§çš„äºŒç»´ç»“æ„ã€‚


<img alt="" src="/images/æ ‘çŠ¶æ•°ç»„â€”äºŒç»´æ¼”ç¤º.gif" style="width:50%;margin-left:25%"/>

ä»¥ä¸‹æä¾›å•ç‚¹ä¿®æ”¹ã€çŸ©é˜µæŸ¥è¯¢å’ŒçŸ©é˜µä¿®æ”¹ã€å•ç‚¹æŸ¥è¯¢çš„ä»£ç ã€‚

çŸ©é˜µä¿®æ”¹çŸ©é˜µæŸ¥è¯¢åœ¨å®é™…é¢˜ç›®ä¸­åº”ç”¨ä¸å¤šï¼Œåœ¨æ­¤ä¸ä»‹ç»ã€‚


{%note success ä¸¤ç§é¢˜ç›®ä»£ç %}
**ä»¥ä¸‹ä»£ç å¿«è¯»æ¨¡æ¿å·²åˆ å»ï¼Œå‹¿ç›´æ¥å¤åˆ¶**

{% tabs äºŒç»´æ ‘çŠ¶æ•°ç»„ä»£ç  %}
<!--tab å•ç‚¹ä¿®æ”¹ï¼ŒçŸ©é˜µæŸ¥è¯¢-->
### å•ç‚¹ä¿®æ”¹ï¼ŒçŸ©é˜µæŸ¥è¯¢

```cpp
#include <bits/stdc++.h>
using namespace std;
#define int long long
int n, m;
int tree[(1LL << 12) + 5][(1LL << 12) + 5];
int lowbit(int x)
{
    return (-x) & x;
}
void add(int x, int y, int val)
{
    for (int i = x; i <= n; i += lowbit(i))
    {
        // æ³¨æ„ä¸èƒ½ç›´æ¥ä¿®æ”¹ yï¼Œä¸‹ä¸€æ¬¡è¿˜è¦ç”¨
        for (int j = y; j <= m; j += lowbit(j))
        {
            tree[i][j] += val;
        }
    }
}
int query(int x, int y)
{
    int sum = 0;
    for (int i = x; i; i -= lowbit(i))
    {
        for (int j = y; j; j -= lowbit(j))
        {
            sum += tree[i][j];
        }
    }
    return sum;
}
int query(int x, int y, int X, int Y)
{
    return query(X, Y) - query(X, y - 1) - query(x - 1, Y) + query(x - 1, y - 1);
}
int op = 0;
int x, y, X, Y, val;
int Q;
signed main()
{
    read(n), read(m), read(Q);
    while (Q--)
    {
        read(op);
        if (op == 1)
        {
            read(x), read(y), read(val);
            add(x, y, val);
        }
        else
        {
            read(x), read(y), read(X), read(Y);
            writeln(query(x, y, X, Y));
        }
    }
    return 0;
}
```
<!--endtab-->
<!--tab çŸ©é˜µä¿®æ”¹ï¼Œå•ç‚¹æŸ¥è¯¢-->
### çŸ©é˜µä¿®æ”¹ï¼Œå•ç‚¹æŸ¥è¯¢

```cpp
#include <bits/stdc++.h>
using namespace std;
#define int long long
int n, m;
int tree[(1LL << 12) + 5][(1LL << 12) + 5];
int lowbit(int x)
{
    return (-x) & x;
}
void add(int x, int y, int val)
{
    for (int i = x; i <= n; i += lowbit(i))
    {
        // æ³¨æ„ä¸èƒ½ç›´æ¥ä¿®æ”¹ yï¼Œä¸‹ä¸€æ¬¡è¿˜è¦ç”¨
        for (int j = y; j <= m; j += lowbit(j))
        {
            tree[i][j] += val;
        }
    }
}
int query(int x, int y)
{
    int sum = 0;
    for (int i = x; i; i -= lowbit(i))
    {
        for (int j = y; j; j -= lowbit(j))
        {
            sum += tree[i][j];
        }
    }
    return sum;
}
int query(int x, int y, int X, int Y)
{
    return query(X, Y) - query(X, y - 1) - query(x - 1, Y) + query(x - 1, y - 1);
}
int op = 0;
int Q=0;
int x, y, X, Y, val;
signed main()
{
    read(n), read(m);
    while (Q--)
    {
        read(op);
        if (op == 1)
        {
            read(x), read(y), read(X), read(Y), read(val);
            add(x, y, val);
            add(X + 1, Y + 1, val);
            add(X + 1, y, -val);
            add(x,Y+1, -val);
        }
        else
        {
            read(X), read(Y);
            writeln(query(X, Y));
        }
    }
    return 0;
}
```
<!--endtab-->
{%endtabs%}
{%endnote%}

## æƒå€¼æ ‘çŠ¶æ•°ç»„

### å¼•å…¥

æƒå€¼æ ‘çŠ¶æ•°ç»„å°±æ˜¯**ç»´æŠ¤åŸæ•°ç»„çš„æƒå€¼æ•°ç»„**çš„æ ‘çŠ¶æ•°ç»„ã€‚

{%note%}

æƒå€¼æ•°ç»„æ˜¯ç»Ÿè®¡ä¸€ä¸ªæ•°ç»„å†…å„ä¸ªæ•°å­—å‡ºç°æ¬¡æ•°çš„æ•°ç»„ã€‚æƒå€¼æ•°ç»„å…ƒç´  $b_{i}$ è¡¨ç¤ºåœ¨ $a$ ä¸­æ•°å­— $i$ å‡ºç°çš„æ¬¡æ•°ä¸º $b_{i}$ï¼Œå³ $b_{x} = \sum_{i = 1}^{n} [a_{i} = x]$ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼ŒåŸæ•°ç»„ $a$ çš„å€¼åŸŸå¯èƒ½è¾ƒå¤§ï¼Œæ­¤æ—¶å¯ä»¥é‡‡ç”¨ [ç¦»æ•£åŒ–]() çš„æ“ä½œå°†å€¼åŸŸç¼©å°åˆ° $\leq n$ çš„èŒƒå›´ã€‚
{%endnote%}

å› æ­¤æƒå€¼æ ‘çŠ¶æ•°ç»„å’Œæ™®é€šæ ‘çŠ¶æ•°ç»„å®ç°æ–¹å¼å¤§ä½“ç›¸åŒï¼Œåªéœ€è¦æ³¨æ„å°†é¢˜ç›®å¯¹åŸæ•°ç»„çš„æ“ä½œè½¬åŒ–åˆ°æƒå€¼æ•°ç»„å³å¯ã€‚

### é€†åºå¯¹é—®é¢˜

é€†åºå¯¹é—®é¢˜æ˜¯æ ‘çŠ¶æ•°ç»„çš„ç»å…¸é—®é¢˜ï¼š

{%note primary%}
ç»™å®šä¸€ä¸ªé•¿åº¦ä¸º $n$ çš„åºåˆ— $a$ï¼ŒæŸ¥è¯¢æ»¡è¶³ $i < j$ ä¸” $a_{i} > a_{j}$ çš„äºŒå…ƒç»„ $(i,j)$ çš„æ•°é‡ã€‚
{%endnote%}

ä¸€ä¸ªå¾ˆæ˜¾ç„¶çš„æš´åŠ›æ˜¯æšä¸¾ $i,j$ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º $O(n^2)$ã€‚

å¦‚æœåŒæ—¶è€ƒè™‘ä¸¤ä¸ªæ¡ä»¶æ˜¾ç„¶æ˜¯å¤æ‚çš„ï¼Œä½†æˆ‘ä»¬å‘ç°ä¸¤ä¸ªé™åˆ¶æ¡ä»¶ä¸­çš„ $i < j$ å¾ˆå¥½å¤„ç†ï¼šä¸‹æ ‡å·²ç»æ˜¯æ’å¥½åºçš„ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥è€ƒè™‘æšä¸¾ä¸‹æ ‡ $i$ï¼Œåˆ™éœ€è¦ç»Ÿè®¡æœ‰å¤šå°‘ä¸ª**ä¹‹å‰çš„ä¸‹æ ‡ $j$** æ»¡è¶³ $a_{j}>a_{i}$ï¼Œå¦‚æœæƒå€¼æ•°ç»„ä¸º $b$ï¼Œä¹Ÿå°±æ˜¯æ±‚ $\large{ \sum\limits_{val = 1}^{a_{i} } b_{val} }$ï¼Œä¹‹åè¦å°† $a_{i}$ æ’å…¥æƒå€¼æ•°ç»„ï¼š$b_{a_{i} } \gets b_{a_{i} } +1$ã€‚


ä¾‹å¦‚å¯¹äºæ•°ç»„ $[5,1,7,3,5,6,4]$ï¼Œå®Œæ•´çš„è®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼ˆç”±äºç¦»æ•£åŒ–æ—¶æœ€å°çš„å…ƒç´ ä¸€èˆ¬è§†ä¸º $1$ï¼Œä»¥ä¸‹æƒå€¼æ•°ç»„çš„ä¸‹æ ‡ä» $1$ å¼€å§‹ï¼‰ï¼š

|$i$|æƒå€¼æ•°ç»„|$\delta ans$|$ans$|
|:--:|:--:|:--:|:--:|
|$1$|$[0,0,0,0,0,{\color{RED}0,0}]$|$0$|$0$|
|$2$|$[0,{\color{RED} 0,0,0,1,0,0}]$|$1$|$1$|
|$3$|$[1,0,0,0,1,0,0]$|$0$|$1$|
|$4$|$[1,0,0,{\color{RED} 0,1,0,1}]$|$2$|$3$|
|$5$|$[1,0,1,0,1,{\color{RED}0,1}]$|$1$|$4$|
|$6$|$[1,0,1,0,2,0,{\color{RED} 1}]$|$1$|$5$|
|$7$|$[1,0,1,0,{\color{RED}2,1,1}]$|$4$|$9$|

è¿™ä¸ªè¿‡ç¨‹å’Œäººè„‘è®¡ç®—é€†åºå¯¹çš„è¿‡ç¨‹è¾ƒä¸ºç›¸ä¼¼ï¼Œå¾ˆå¥½ç†è§£ï¼Œå¯¹æƒå€¼æ•°ç»„çš„æ“ä½œä¸º**å•ç‚¹ä¿®æ”¹ï¼ŒåŒºé—´æŸ¥è¯¢**ï¼Œç”¨æƒå€¼æ ‘çŠ¶æ•°ç»„ç»´æŠ¤å³å¯ã€‚



æ­¤æ—¶è§£æ³•å°±æœ‰äº†ï¼š

{%note success%}

åˆå§‹æƒå€¼æ ‘çŠ¶æ•°ç»„å…¨ä¸º $0$ï¼Œå¯¹åŸæ•°ç»„å†…çš„å€¼è¿›è¡Œç¦»æ•£åŒ–ã€‚

ä»å·¦åˆ°å³éå†æ¯ä¸€ä¸ªä¸‹æ ‡ $i$ï¼Œåˆ©ç”¨æƒå€¼æ ‘çŠ¶æ•°ç»„æŸ¥è¯¢ $a_{i} < a_{k} \leq \max(a)$ çš„ $k$ çš„æ•°é‡ï¼Œè®¡å…¥å¤§ç­”æ¡ˆã€‚

å°†å½“å‰ä½ç½®æ’å…¥æ ‘çŠ¶æ•°ç»„ï¼ˆå¯¹åº”æƒå€¼æ•°ç»„çš„æ“ä½œä¸ºä¸‹æ ‡ä¸º $a_{i}$ï¼ˆç¦»æ•£åŒ–åï¼‰çš„å€¼ $+1$ï¼‰ï¼Œå³ä¸º `add(a[i],1)`ã€‚


{% lg /images/logo.png %}
SY53 é€†åºå¯¹ | https://oj.cnryh.cn/problem#/SY53 | 11 Online Judge
{% endlg %}


å®ç°ä»£ç å¦‚ä¸‹ï¼š

```cpp
```
{%endnote%}